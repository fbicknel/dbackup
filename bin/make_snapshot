#!/usr/bin/env bash

function cleanup_snapshots () {
    declare -a F_SNAPSHOTS=("${!1}")
    local F_KEEP=$2
    local F_SNAPSHOT_QTY=${#F_SNAPSHOTS[@]}
    if [ $F_SNAPSHOT_QTY -eq 0 ]; then
        echo "No snapshots to clean up."
        return
    fi
    echo "Found $F_SNAPSHOT_QTY incremental snapshots. Clean up until $F_KEEP remain..."
    if [ $F_SNAPSHOT_QTY -lt $F_KEEP ]; then
        echo "Not enough snapshots to clean up (need at least $F_KEEP)"
        return
    fi
    # from  the array of snapshots we were given, we're going to want the
    # first (oldest), and last (newest) one
    local F_FIRST_SNAPSHOT=${F_SNAPSHOTS[0]}
    local F_LAST_SNAPSHOT=${F_SNAPSHOTS[-1]}
    local F_LAST_DELETED
    let F_LAST_DELETED=$F_SNAPSHOT_QTY-$F_KEEP
    local F_N=$F_LAST_DELETED
    local SS
    for SS in ${F_SNAPSHOTS[@]:0:$F_LAST_DELETED}; do
        echo "**** Cleaning up snapshot: $F_FIRST_SNAPSHOT (# $F_N)"
        if [ -n "$DRY_RUN" ]; then
            echo "(dry-run)"
            echo zfs destroy $SS
        else
            $SUDO zfs destroy $SS
        fi
        let F_N=${F_N}-1
    done
}
 
STARTTIME=$(date +%s)
echo "begin at $(date)."
SUDO=/usr/bin/sudo
POSITIONAL=()
while [[ $# -gt 0 ]]
do
key="$1"

case $key in
    -f|--force-full)
        FORCE_NEW="-new"
        shift # past argument
        ;;
    -p|--pool)
        POOL="$2"
        shift
        shift
        ;;
    -l|--use-last)
        USE_LAST_SNAPSHOT=1
        shift # past argument
        ;;
    -d|--dry-run)
        DRY_RUN=1
        shift;
        ;;
    *)    # unknown option
        POSITIONAL+=("$1") # save it in an array for later
        shift # past argument
        ;;
esac
done
set -- "${POSITIONAL[@]}" # restore positional parameters
: ${POOL:=backup} #default is backup
# SUDO="echo"
SOURCE=${1:-home/fbicknel}
TARGET=${2:-$POOL/fbicknel_backup}
if [ -n "$FORCE_NEW" -a -n "$USE_LAST_SNAPSHOT" ]; then
    echo "You can't try to force a new full and say use the last snapshot"
    echo "--force-full and --use-last are mutually exclusive"
    exit 1
fi

echo "Backup from $SOURCE -> $TARGET"
if [ "$USE_LAST_SNAPSHOT" == 1 ]; then
    echo "We are using the last incremental snapshot."
else
    if [ -n "$DRY_RUN" ]; then
        echo "(dry-run)"
        echo zfs snapshot "${SOURCE}@backup_$(date +%s)" 
    else
        $SUDO zfs snapshot "${SOURCE}@backup_$(date +%s)" # this is what we're here for
    fi
fi
# First targets:
T_SNAPSHOTS=($($SUDO zfs list -Ht snapshot -r $TARGET | awk '/backup_[0-9]/ {print $1}'))
TF_SNAPSHOTS=($($SUDO zfs list -Ht snapshot -r $TARGET | awk '/backup_F_[0-9]/ {print $1}'))

# Now sources;
S_SNAPSHOTS=($($SUDO zfs list -Ht snapshot -r $SOURCE | awk '/backup_[0-9]/ {print $1}'))
if [ "$USE_LAST_SNAPSHOT" == 1 ]; then
    echo "The last incremental snapshot was: ${S_SNAPSHOTS[-1]}"
fi
SF_SNAPSHOTS=($($SUDO zfs list -Ht snapshot -r $SOURCE | awk '/backup_F_[0-9]/ {print $1}'))
SF_SNAPSHOT_QTY=${#SF_SNAPSHOTS[@]}
TF_SNAPSHOT_QTY=${#TF_SNAPSHOTS[@]}
let S_SNAPSHOT_QTY=${#S_SNAPSHOTS[@]}+${#SF_SNAPSHOTS[@]}
let T_SNAPSHOT_QTY=${#T_SNAPSHOTS[@]}+${#TF_SNAPSHOTS[@]}
echo "Found $S_SNAPSHOT_QTY total source snapshots."
echo "Found $T_SNAPSHOT_QTY total target snapshots."
if [ "$FORCE_NEW" = '-new' -o $T_SNAPSHOT_QTY -eq 0 \
    -o $S_SNAPSHOT_QTY -lt 2 -o $SF_SNAPSHOT_QTY -eq 0 ]; then
    if [ "$FORCE_NEW" = '-new' ]; then
        echo "Found -new as arg 3 on the command line."
    elif [ $SF_SNAPSHOT_QTY -eq 0 ]; then
        echo "No full snapshots found on source: start over"
    else
        echo "Not enough snapshots of either source ($S_SNAPSHOT_QTY) or target ($T_SNAPSHOT_QTY)"
    fi
    echo "**** Sending first snapshot, then."
    echo -e "\tRemoving all source _backup snapshots"
    S_SNAPSHOTS=($($SUDO zfs list -Ht snapshot -r $SOURCE | awk '/backup_/ {print $1}'))
    cleanup_snapshots S_SNAPSHOTS[@] 0
    echo -e "\tRemoving all target snapshots (ALL)"
    AT_SNAPSHOTS=($($SUDO zfs list -Ht snapshot -r $TARGET | awk '{print $1}'))
    cleanup_snapshots AT_SNAPSHOTS[@] 0
    echo -e "\tRemoving target ($TARGET)..."
    if [ -n "$DRY_RUN" ]; then
        echo "(dry-run)"
        echo zfs destroy $TARGET
    else
        $SUDO zfs destroy $TARGET
    fi
    echo -e "\tCreate new snapshot on source ($SOURCE)"
    # Note the _F_ in the snapshot name: this denotes the 'full' progenitor
    if [ -n "$DRY_RUN" ]; then
        echo zfs snapshot "${SOURCE}@backup_F_$(date +%s)" 
        echo "(dry-run)"
    else
        $SUDO zfs snapshot "${SOURCE}@backup_F_$(date +%s)" # this is what we're here for
    fi
    S_SNAPSHOTS=($($SUDO zfs list -Ht snapshot -r $SOURCE | awk '/backup_/ {print $1}'))
    echo -e "\tSending first full snapshot"
    if [ -n "$DRY_RUN" ]; then
        echo "(dry-run)"
        echo "zfs send ${S_SNAPSHOTS[0]} | $SUDO zfs receive -F $TARGET"
        RV=0
    else
        $SUDO zfs send ${S_SNAPSHOTS[0]} | $SUDO zfs receive -F $TARGET
        RV=$?
    fi
else
    T_KEEP=5
    echo "Clean up target snapshots:"
    if [ -n "$DRY_RUN" ]; then
        echo "(dry-run)"
        echo cleanup_snapshots T_SNAPSHOTS[@] $T_KEEP
    fi
    cleanup_snapshots T_SNAPSHOTS[@] $T_KEEP
    S_KEEP=5
    echo "Clean up source snapshots:"
    if [ -n "$DRY_RUN" ]; then
        echo "(dry-run)"
        echo cleanup_snapshots S_SNAPSHOTS[@] $S_KEEP
    fi
    cleanup_snapshots S_SNAPSHOTS[@] $S_KEEP
    SF_SNAPSHOTS=($($SUDO zfs list -Ht snapshot -r $SOURCE | awk '/backup_F_/ {print $1}'))
    S_FULL_SNAPSHOT=${SF_SNAPSHOTS[-1]}
    S_LAST_SNAPSHOT=${S_SNAPSHOTS[-1]}
    let S_LAST_DELETED=$S_SNAPSHOT_QTY-$S_KEEP
    echo "Sending incremental snapshot data from $S_FULL_SNAPSHOT..$S_LAST_SNAPSHOT to $TARGET"
    if [ -n "$DRY_RUN" ]; then
        echo "(dry-run)"
        echo "zfs send -i $S_FULL_SNAPSHOT $S_LAST_SNAPSHOT | zfs receive -F $TARGET"
        RV=0
    else
        $SUDO zfs send -i $S_FULL_SNAPSHOT $S_LAST_SNAPSHOT | $SUDO zfs receive -F $TARGET
        RV=$?
    fi
fi
ENDTIME=$(date +%s)
echo "done at $(date). $(($ENDTIME - $STARTTIME)) elapsed seconds"
exit $RV
